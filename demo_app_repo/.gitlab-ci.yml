stages: [build, test, scan, deploy]

variables:
  REGISTRY: "localhost:${REGISTRY_PORT:-5000}"
  IMAGE_NAME: "$REGISTRY/$CI_PROJECT_PATH_SLUG"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  IMAGE_FULL: "$IMAGE_NAME:$IMAGE_TAG"
  APP_HOST_PORT: "8088"           # host port for demo container
  APP_CONTAINER_PORT: "80"        # nginx listens on 80
  DEPLOY_CONTAINER: "demo-app"
  DOCKER_BUILDKIT: "1"

build:
  stage: build
  image: docker:27-cli
  tags: [docker]
  script:
    - docker version
    - echo "Building $IMAGE_FULL"
    - docker build -t "$IMAGE_FULL" .
    - docker tag "$IMAGE_FULL" "$IMAGE_NAME:latest"
    - echo "Pushing to local registry ($REGISTRY)"
    - docker push "$IMAGE_FULL"
    - docker push "$IMAGE_NAME:latest"

test:
  stage: test
  image: alpine:3.20
  tags: [docker]
  script:
    - test -f Dockerfile
    - test -f index.html
    - grep -q "Hello from GitLab CI" index.html
    - echo "Basic repo sanity OK"

scan:
  stage: scan
  image: docker:27-cli
  tags: [docker]
  script:
    - echo "Scan filesystem (repo) with Trivy"
    - docker run --rm -v "$CI_PROJECT_DIR:/repo" aquasec/trivy:latest fs --severity HIGH,CRITICAL --exit-code 0 /repo
    - echo "Scan built image with Trivy"
    - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --severity HIGH,CRITICAL --exit-code 0 "$IMAGE_FULL"

deploy:
  stage: deploy
  image: docker:27-cli
  tags: [deploy]
  resource_group: production
  script:
    - echo "Deploying $IMAGE_FULL -> container=$DEPLOY_CONTAINER port=$APP_HOST_PORT:$APP_CONTAINER_PORT"
    - docker rm -f "$DEPLOY_CONTAINER" || true
    - docker run -d --name "$DEPLOY_CONTAINER" --restart unless-stopped -p "$APP_HOST_PORT:$APP_CONTAINER_PORT" "$IMAGE_FULL"
    - docker ps --filter "name=$DEPLOY_CONTAINER"
