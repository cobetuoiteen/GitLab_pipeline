name: lab

services:
  postgres:
    image: postgres:16
    container_name: gitlab-postgres
    profiles: ["db", "core"]
    environment:
      POSTGRES_USER: ${GITLAB_DB_USER:-gitlab}
      POSTGRES_PASSWORD: ${GITLAB_DB_PASSWORD:-gitlabpass}
      POSTGRES_DB: ${GITLAB_DB_NAME:-gitlabhq_production}
    volumes:
      - gitlab_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${GITLAB_DB_USER:-gitlab} -d ${GITLAB_DB_NAME:-gitlabhq_production}"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

    mem_limit: 2g
    cpus: 1.0
    pids_limit: 512

  gitlab:
    image: gitlab/gitlab-ce:18.6.1-ce.0
    container_name: gitlab
    profiles: ["scm", "core"]
    stop_grace_period: 2m
    stop_signal: SIGTERM
    depends_on:
      postgres:
        condition: service_healthy
    hostname: ${GITLAB_HOSTNAME:-gitlab}

    networks:
      default:
        aliases:
          - gitlab.local
    ports:
      - "${GITLAB_HTTP_PORT:-8080}:80"
      - "${GITLAB_HTTPS_PORT:-8443}:443"
      - "${GITLAB_SSH_PORT:-2222}:22"

    environment:
      GITLAB_ROOT_PASSWORD: ${GITLAB_ROOT_PASSWORD:-Password@123}
      GITLAB_ROOT_EMAIL: ${GITLAB_ROOT_EMAIL:-root@example.local}

      GITLAB_OMNIBUS_CONFIG: |
        external_url '${GITLAB_EXTERNAL_URL:-http://${IP_LOCAL}:8080}'

        nginx['listen_port'] = 80
        nginx['listen_https'] = false
        puma['worker_processes'] = 2
        puma['min_threads'] = 2
        puma['max_threads'] = 2
        sidekiq['concurrency'] = 5

        postgresql['enable'] = false
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'unicode'
        gitlab_rails['db_host'] = '${GITLAB_DB_HOST:-postgres}'
        gitlab_rails['db_port'] = ${GITLAB_DB_PORT:-5432}
        gitlab_rails['db_database'] = '${GITLAB_DB_NAME:-gitlabhq_production}'
        gitlab_rails['db_username'] = '${GITLAB_DB_USER:-gitlab}'
        gitlab_rails['db_password'] = '${GITLAB_DB_PASSWORD:-gitlabpass}'

        # gitlab_rails['gitlab_host'] = '192.168.1.12'
        # gitlab_rails['gitlab_port'] = 8080
        # gitlab_rails['gitlab_https'] = false

        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SSH_PORT:-2222}

        # Using built-in Redis now, will improve later if needed.
        # redis['enable'] = true

    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab

    # Needed because runner services use condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/-/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 40

    restart: unless-stopped

    mem_limit: 10g
    cpus: 4.0
    pids_limit: 4096

  # Local Docker Registry for demo push/pull images
  registry:
    image: registry:2
    container_name: lab-registry
    profiles: ["core"]
    ports:
      - "${REGISTRY_PORT:-5000}:5000"
    volumes:
      - registry_data:/var/lib/registry
    restart: unless-stopped

  # Demo database (separate from GitLab DB) for Grafana datasource tests
  appdb:
    image: postgres:16
    container_name: appdb
    profiles: ["core"]
    environment:
      POSTGRES_USER: ${APPDB_USER:-app}
      POSTGRES_PASSWORD: ${APPDB_PASSWORD:-apppass}
      POSTGRES_DB: ${APPDB_DB:-appdb}
    ports:
      - "${APPDB_HOST_PORT:-5433}:5432"
    volumes:
      - appdb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${APPDB_USER:-app} -d ${APPDB_DB:-appdb}"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    profiles: ["core"]
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin123}
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped

  gitlab-runner-register:
    image: gitlab/gitlab-runner:alpine
    container_name: gitlab-runner-register
    profiles: ["ci"]
    depends_on:
      gitlab:
        condition: service_healthy
    restart: "no"
    environment:
      CI_SERVER_URL: ${CI_SERVER_URL}
      RUNNER_TOKEN: ${RUNNER_TOKEN}
      RUNNER_NAME: ${RUNNER_NAME:-runner-laptop-01}
      DOCKER_IMAGE: ${DOCKER_IMAGE:-alpine:3.20}
      RUNNER_TAG_LIST: "${RUNNER_TAG_LIST:-docker,linux,lab}"
      RUN_UNTAGGED: "${RUN_UNTAGGED:-true}"
      DOCKER_NETWORK_MODE: "${DOCKER_NETWORK_MODE:-lab_default}"
    volumes:
      - gitlab_runner_config:/etc/gitlab-runner
      - gitlab_runner_cache:/cache
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-register.sh:/scripts/runner-register.sh:ro
    entrypoint: ["/bin/sh", "/scripts/runner-register.sh"]

  gitlab-runner:
    image: gitlab/gitlab-runner:alpine
    container_name: gitlab-runner
    profiles: ["ci", "runners"]
    depends_on:
      gitlab-runner-register:
        condition: service_completed_successfully
    restart: unless-stopped
    volumes:
      - gitlab_runner_config:/etc/gitlab-runner
      - gitlab_runner_cache:/cache
      - /var/run/docker.sock:/var/run/docker.sock

    mem_limit: 1024m
    cpus: 1.0
    pids_limit: 256

    command: ["run", "--working-directory=/home/gitlab-runner"]

  gitlab-runner-deploy-register:
    image: gitlab/gitlab-runner:alpine
    container_name: gitlab-runner-deploy-register
    profiles: ["ci"]
    depends_on:
      gitlab:
        condition: service_healthy
    restart: "no"
    environment:
      CI_SERVER_URL: ${CI_SERVER_URL}
      RUNNER_TOKEN: ${RUNNER_DEPLOY_TOKEN}
      RUNNER_NAME: ${RUNNER_DEPLOY_NAME:-runner-deploy-01}
      DOCKER_IMAGE: ${DOCKER_IMAGE_DEPLOY:-alpine:3.20}
      RUNNER_TAG_LIST: ${RUNNER_DEPLOY_TAG_LIST:-deploy}
      RUN_UNTAGGED: ${RUN_UNTAGGED_DEPLOY:-false}
      DOCKER_NETWORK_MODE: ${DOCKER_NETWORK_MODE:-lab_default}
    volumes:
      - gitlab_runner_deploy_config:/etc/gitlab-runner
      - gitlab_runner_deploy_cache:/cache
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-register.sh:/scripts/runner-register.sh:ro
    entrypoint: ["/bin/sh", "/scripts/runner-register.sh"]

  gitlab-runner-deploy:
    image: gitlab/gitlab-runner:alpine
    container_name: gitlab-runner-deploy
    profiles: ["ci", "runners"]
    depends_on:
      gitlab-runner-deploy-register:
        condition: service_completed_successfully
    restart: unless-stopped
    volumes:
      - gitlab_runner_deploy_config:/etc/gitlab-runner
      - gitlab_runner_deploy_cache:/cache
      - /var/run/docker.sock:/var/run/docker.sock
    mem_limit: 1024m
    cpus: 1.0
    pids_limit: 256
    command: ["run", "--working-directory=/home/gitlab-runner"]

volumes:
  gitlab_pgdata:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  gitlab_runner_config:
  gitlab_runner_cache:
  gitlab_runner_deploy_config:
  gitlab_runner_deploy_cache:
  registry_data:
  grafana_data:
  appdb_data:
